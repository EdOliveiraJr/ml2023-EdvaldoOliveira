define(["require","exports","tslib","react","modules/clean/filepath","modules/core/uri","modules/core/i18n","modules/clean/react/css","spectrum/popover","modules/clean/static_urls","modules/clean/react/file_viewer/open_button/types","modules/clean/react/app_actions/category","modules/clean/react/app_actions/redirect","modules/clean/react/sprite","spectrum/icon_action","spectrum/icon_document","modules/clean/react/file_viewer/unity/with_unity","modules/clean/react/file_viewer/constants","modules/clean/react/app_actions/byline","modules/clean/react/app_actions/redirect","modules/clean/react/extensions/comm_app_value/text","modules/clean/react/extensions/comm_app_value/info_tooltip","modules/clean/react/extensions/comm_app_value/info_modal"],function(e,t,a,n,o,i,r,s,p,c,l,u,d,m,_,f,h,g,y,v,E,N,w){"use strict";function I(e){return void 0!==e.openOptionName}function A(e,t,n,o,i){return a.__awaiter(this,void 0,Promise,function(){var r,s;return a.__generator(this,function(a){switch(a.label){case 0:return r=function(){return o.then(function(e){return{redirect_url:i(e).toString()}})},[4,v.showLoadingPageAndDoRedirect(t,void 0,e,n.file_id,r,"width=800,height=600")];case 1:return s=a.sent(),[2,void 0!==s]}})})}function C(t,n){return a.__awaiter(this,void 0,Promise,function(){var o,i,r,s,p,c,l;return a.__generator(this,function(u){switch(u.label){case 0:return[4,new Promise(function(t,a){e(["modules/clean/api_v2/user_client"],t,a)}).then(a.__importStar)];case 1:o=u.sent().UserApiV2Client,i=new o,r={path:n.file_id},u.label=2;case 2:return u.trys.push([2,4,,5]),s={path:n.file_id,settings:{requested_visibility:{".tag":"public"}}},[4,i.ns("sharing").rpc("alpha/create_shared_link_with_settings",s,{subjectUserId:t.id})];case 3:return p=u.sent(),[2,p.url];case 4:if(c=u.sent(),!c.error||"shared_link_already_exists"!==c.error[".tag"])throw c;return[3,5];case 5:return[4,i.ns("sharing").rpc("list_shared_links",r,{subjectUserId:t.id})];case 6:if(l=u.sent(),0===l.links.length)throw new Error("Expected get result to contain at least one entry");return[2,l.links[0].url]}})})}function O(e,t){var a=o.filename(t.ns_path),n=C(e,t).then(function(e){return{subject:r._("%(file_name)s - Shared with Dropbox").format({file_name:a}),body:e}});return A(r._("Gmail"),e,t,n,P)}function x(e,t){var a=o.filename(t.ns_path),n=C(e,t).then(function(e){return{subject:r._("%(file_name)s - Shared with Dropbox").format({file_name:a}),body:e}});return A(r._("Outlook"),e,t,n,S)}function D(e,t){var a=o.filename(t.ns_path),n=C(e,t).then(function(e){return{subject:r._("%(file_name)s - Shared with Dropbox").format({file_name:a}),body:e}});return A(r._("WhatsApp"),e,t,n,k)}Object.defineProperty(t,"__esModule",{value:!0}),n=a.__importDefault(n),o=a.__importStar(o);var b=[{entries:[{openOptionName:"unity"}]},{displayName:r._("Edit"),entries:[{openOptionName:"openWith"},{categoryId:u.Category.OPEN_WITH_CLOUD_DOC}]},{displayName:r._("Edit"),descriptionFn:E.CategoryDescription.editPdf,entries:[{categoryId:u.Category.PDF_EDITING}]},{displayName:r._("Edit"),descriptionFn:E.CategoryDescription.editImage,entries:[{categoryId:u.Category.IMAGE_EDITING}]},{displayName:u.Category.getDisplayName(u.Category.VIDEO_EDITING),entries:[{categoryId:u.Category.VIDEO_EDITING}]},{displayName:r._("Copy to"),entries:[{openOptionName:"copyTo"}]},{displayName:u.Category.getDisplayName(u.Category.VIDEO_COMMENT),descriptionFn:E.CategoryDescription.videoCommenting,entries:[{categoryId:u.Category.VIDEO_COMMENT}]},{displayName:u.Category.getDisplayName(u.Category.VIEW_OR_EDIT),descriptionFn:E.CategoryDescription.autoCad,entries:[{categoryId:u.Category.VIEW_OR_EDIT}]},{displayName:r._("Send with"),entries:[{openOptionName:"email"},{openOptionName:"share"}]},{displayName:r._("Present"),entries:[{openOptionName:"present"}]},{displayName:u.Category.getDisplayName(u.Category.ESIGNATURE),descriptionFn:E.CategoryDescription.sign,entries:[{openOptionName:"esignature"},{categoryId:u.Category.ESIGNATURE}]},{displayName:u.Category.getDisplayName(u.Category.SEND_FAX),descriptionFn:E.CategoryDescription.fax,entries:[{categoryId:u.Category.SEND_FAX}]},{displayName:r._("Download"),entries:[{openOptionName:"download"}]},{displayName:r._("TESTING"),entries:[{categoryId:u.Category.DEFAULT}]}],T=(function(e){function t(t){var o=e.call(this,t)||this;return o.handleSentViaGmail=function(){return a.__awaiter(o,void 0,void 0,function(){var e,t,n,o;return a.__generator(this,function(a){switch(a.label){case 0:return e=this.props,t=e.user,n=e.file,this.logEvent("select_gmail_action",{}),[4,O(t,n)];case 1:return o=a.sent(),o?this.logEvent("select_gmail_action_success",{}):this.logEvent("select_gmail_action_failure",{}),[2]}})})},o.handleSendViaOutlook=function(){return a.__awaiter(o,void 0,void 0,function(){var e,t,n,o;return a.__generator(this,function(a){switch(a.label){case 0:return e=this.props,t=e.user,n=e.file,this.logEvent("select_outlook_action",{}),[4,x(t,n)];case 1:return o=a.sent(),o?this.logEvent("select_outlook_action_success",{}):this.logEvent("select_outlook_action_failure",{}),[2]}})})},o.handleSendViaWhatsApp=function(){return a.__awaiter(o,void 0,void 0,function(){var e,t,n,o;return a.__generator(this,function(a){switch(a.label){case 0:return e=this.props,t=e.user,n=e.file,[4,D(t,n)];case 1:return o=a.sent(),o?this.logEvent("select_whats_app_action_success",{}):this.logEvent("select_whats_app_action_failure",{}),[2]}})})},o.renderCategory=function(e){var t=o.props.extensionsConfig.featureFlags.expCommAppValue,a=t&&["VARIANT_3","VARIANT_4"].indexOf(t)>=0,i=o.props.extensionsConfig.featureFlags.expPersonalization;a=a||"V2"===i;var r=a&&e.description?n.default.createElement("div",{className:"app-action__category-subtitle"},e.description):null;return n.default.createElement(p.PopoverItemGroup,{className:"app-action-category-group",key:e.key},e.displayName?n.default.createElement(p.PopoverItemGroupTitle,{className:"app-action-category-title"},e.displayName):null,r,e.actions.map(function(e){return o.renderActionRow(e)}),n.default.createElement(p.PopoverItemGroupSeparator,{className:"app-action-menu-separator"}))},o.wrapperForAction=function(e,t,n){var i=o.props,s=i.file,p=i.user,c=i.extensionsConfig;return{handler:function(){return a.__awaiter(o,void 0,void 0,function(){var o,i,l,u,m=this;return a.__generator(this,function(_){switch(_.label){case 0:return o=c.featureFlags.expCommAppValue,n||"VARIANT_2"!==o?[3,2]:(i=e.app_id,(l=E.modalCopyMap[i])?(this.logEvent("show_action_info",{action_id:e.id,encoded_app_id:e.app_id}),u=new Promise(function(n){return a.__awaiter(m,void 0,void 0,function(){return a.__generator(this,function(a){return w.showModal({appName:e.description,appIconUrl:t,shortDescription:r._("Web app"),entries:l,onGetStarted:n},"file-viewer-modal-overlay"),[2]})})}),[4,u]):[3,2]);case 1:_.sent(),_.label=2;case 2:return d.redirectToAction(p,e.id,e.description,s.file_id),this.logEvent("select_action",{action_id:e.id,encoded_app_id:e.app_id}),[2]}})})},userAction:g.UserAction.OpenWithAppAction,actionName:e.description}},o.handleImgLoadError=function(){o.props.refreshAppIcons&&o.props.refreshAppIcons({user:o.props.user})},o.renderActionRow=function(e){if(!o.isApiAppAction(e))return e;var t,a=o.props.appIcons[e.app_id];t=a.is_static?c.static_url("/static/images/generic_app_icon-vflIPYT1H.png"):a.url;var i,s=e.link_state[".tag"].indexOf("_linked")>=0,l=o.props.extensionsConfig.featureFlags.expCommAppValue,u=l&&["CONTROL","VARIANT_1","VARIANT_2","VARIANT_3","VARIANT_4"].indexOf(l)>=0;if(l&&["VARIANT_1","VARIANT_2"].indexOf(l)>=0){var d=e.app_id,m=E.inlineAppDescriptionMap[d];i=m?n.default.createElement("div",{className:"app-action__inline-value-description"},s?r._("Connected"):m):null}var _=n.default.createElement(p.PopoverContentItem,{className:"app-action-row",key:e.id,value:o.wrapperForAction(e,t,s)},n.default.createElement("div",null,n.default.createElement("div",{className:"app-action-row-content"},n.default.createElement("img",{className:"app-action-popover-icon",src:t,alt:"",onError:o.handleImgLoadError}),n.default.createElement("div",{className:"app-action-popover-item-info"},e.description)),i));if("VARIANT_4"===l){var d=e.app_id,f=E.tooltipEntryMap[d],h=function(){o.logEvent("show_info_tooltip",{action_id:e.id,encoded_app_id:e.app_id})};if(f)return n.default.createElement(N.Tooltip,{appName:e.description,appIconUrl:t,shortDescription:r._("Web app"),entries:f,onLongHover:h},_)}else if(u)return _;return n.default.createElement(y.ExtensionsBylineTooltip,{bylines:o.props.extensionsConfig.bylines[e.app_id],onDidShow:o.handleShowByline(e.app_id)},_)},o.state={popoverContentPosition:"below",showTooltip:void 0},o}return a.__extends(t,e),t.prototype.includeDownloadInMenu=function(){return this.props.showAsButtonIfDownloadOnly},t.prototype.logEvent=function(e,t){this.props.currentSession&&this.props.currentSession.event(e,t)},t.prototype.getOpenOptionsWithLogging=function(e){var t=this;return e.map(function(e){return a.__assign({},e,{handler:function(){e.handler(),t.logEvent("select_legacy_action",{type:e.type})}})})},t.prototype.handleShowByline=function(e){var t=this;return function(){t.logEvent("show_byline",{extension_id:e})}},t.prototype.renderOpenOptions=function(e){var t=this,a=this.props.extensionsConfig.bylines,o=this.getOpenOptionsWithLogging(e),i=[],s=[],u=[],d=[],h=[],g=[],v=[],E=[];if(o.forEach(function(e){var o=e.type,E=o===l.OpenButtonAction.OPEN_IN_PAPER,N=o===l.OpenButtonAction.OPEN_WITH,w=o===l.OpenButtonAction.UNITY_FILE||o===l.OpenButtonAction.UNITY_FOLDER,I=o===l.OpenButtonAction.DOWNLOAD,A=o===l.OpenButtonAction.PREPARE_FOR_SIGNATURE,C=o===l.OpenButtonAction.SHARE_TO_SLACK,O=o===l.OpenButtonAction.PRESENT_IN_ZOOM;if(o===l.OpenButtonAction.OPEN_WITH_CLOUD_DOC)s.push(n.default.createElement(y.ExtensionsBylineTooltip,{bylines:a.cloud_doc,onDidShow:t.handleShowByline("cloud_doc")},n.default.createElement(p.PopoverContentItem,{key:e.text,value:e,className:"app-action-row"},n.default.createElement("div",{className:"app-action-row-content"},n.default.createElement("img",{alt:e.text,src:e.iconUrl,className:"app-action-popover-icon"}),n.default.createElement("span",{className:"app-action-legacy-option-text"},e.text)))));else if(E&&e.spriteName)i.push(n.default.createElement(y.ExtensionsBylineTooltip,{bylines:a.paper,onDidShow:t.handleShowByline("paper")},n.default.createElement(p.PopoverContentItem,{className:"app-action-row",key:e.text,value:e},n.default.createElement("div",{className:"app-action-row-content"},n.default.createElement("img",{alt:"",src:c.static_url("/static/images/paper/paper-icon-vfluG3iA1.png"),className:"app-action-popover-icon"}),n.default.createElement("span",{className:"app-action-legacy-option-text"},r._("Paper"))))));else if((w||N)&&e.spriteName){var x=w?u:s,D=w?"unity":"wopi";x.push(n.default.createElement(y.ExtensionsBylineTooltip,{bylines:a[D],onDidShow:t.handleShowByline(D)},n.default.createElement(p.PopoverContentItem,{key:e.text,value:e,className:"app-action-row"},n.default.createElement("div",{className:"app-action-row-content"},n.default.createElement(m.Sprite,{group:"web",name:e.spriteName,alt:e.text,className:"app-action-popover-icon-sprite"}),n.default.createElement("span",{className:"app-action-legacy-option-text"},e.text)))))}else I&&t.includeDownloadInMenu()?d.push(n.default.createElement(p.PopoverContentItem,{key:e.text,value:e,className:"app-action-row"},n.default.createElement("div",{className:"app-action-row-content"},n.default.createElement(_.IconAction,{className:"app-action-popover-icon-svg",name:"download"}),n.default.createElement("span",{className:"app-action-legacy-option-text"},e.text)))):C?g.push(n.default.createElement(p.PopoverContentItem,{key:e.text,value:e,className:"app-action-row"},n.default.createElement("div",{className:"app-action-row-content"},n.default.createElement("img",{alt:r._("Share to Slack"),src:c.static_url("/static/images/thirdparty/slack_icon-vflKvKltK.svg"),className:"app-action-popover-icon"}),n.default.createElement("span",{className:"app-action-legacy-option-text"},e.text)))):O?v.push(n.default.createElement(p.PopoverContentItem,{key:e.text,value:e,className:"app-action-row"},n.default.createElement("div",{className:"app-action-row-content"},n.default.createElement("img",{alt:r._("Zoom"),src:c.static_url("/static/images/thirdparty/zoom_squircle-vflImll5V.svg"),className:"app-action-popover-icon"}),n.default.createElement("span",{className:"app-action-legacy-option-text"},e.text)))):A&&h.push(n.default.createElement(p.PopoverContentItem,{key:e.text,value:e,className:"app-action-row"},n.default.createElement("div",{className:"app-action-row-content"},n.default.createElement(f.IconDocument,{className:"app-action-popover-icon-svg",name:"signature-small"}),n.default.createElement("span",{className:"app-action-legacy-option-text"},e.text))))}),"ON"===this.props.extensionsConfig.featureFlags.expGmailAction){var N={name:"gmail",handler:this.handleSentViaGmail};E.push(n.default.createElement(p.PopoverContentItem,{key:"gmail",value:N,className:"app-action-row"},n.default.createElement("div",{className:"app-action-row-content"},n.default.createElement("img",{alt:"",src:c.static_url("/static/images/thirdparty/gmail_icon-vflugrKbt.png"),className:"app-action-popover-icon"}),n.default.createElement("span",{className:"app-action-legacy-option-text"},r._("Gmail")))))}if("ON"===this.props.extensionsConfig.featureFlags.expWhatsAppAction){var N={name:"whatsapp",handler:this.handleSendViaWhatsApp};g.push(n.default.createElement(p.PopoverContentItem,{key:"whatsapp",value:N,className:"app-action-row"},n.default.createElement("div",{className:"app-action-row-content"},n.default.createElement("img",{alt:"",src:c.static_url("/static/images/thirdparty/whats_app_icon-vflPumid4.png"),className:"app-action-popover-icon"}),n.default.createElement("span",{className:"app-action-legacy-option-text"},r._("WhatsApp")))))}if("ON"===this.props.extensionsConfig.featureFlags.expOutlookAction){var N={name:"outlook",handler:this.handleSendViaOutlook};E.push(n.default.createElement(p.PopoverContentItem,{key:"outlook",value:N,className:"app-action-row"},n.default.createElement("div",{className:"app-action-row-content"},n.default.createElement("img",{alt:"",src:c.static_url("/static/images/thirdparty/outlook_icon-vflzzt-G0.svg"),className:"app-action-popover-icon"}),n.default.createElement("span",{className:"app-action-legacy-option-text"},r._("Outlook")))))}return{copyTo:i,openWith:s,unity:u,download:d,share:g,present:v,esignature:h,email:E}},t.prototype.renderActions=function(e){var t={};this.props.extensionsConfig.actionCategories.map(function(e){t[e.categoryId]=e});var a=[];b.map(function(n,o){for(var i=[],r=0,s=n.entries;r<s.length;r++){var p=s[r];I(p)?i.push.apply(i,e[p.openOptionName]):t[p.categoryId]&&i.push.apply(i,t[p.categoryId].actions)}i.length>0&&a.push({displayName:n.displayName,description:n.descriptionFn&&n.descriptionFn(i.length),key:"category-"+o,actions:i})});var o=a.map(this.renderCategory);return n.default.createElement("div",null,o)},t.prototype.isApiAppAction=function(e){return void 0!==e.url},t.prototype.render=function(){var e=this.props.openOptions,t=this.renderOpenOptions(e);return this.renderActions(t)},t.defaultProps={showAsButtonIfDownloadOnly:!1,unityInfo:{}},t})(n.default.Component),P=function(e){return new i.URI({scheme:"https",authority:"mail.google.com",path:"/mail/",query:{view:"cm",fs:"1",su:e.subject,body:e.body}})},S=function(e){return new i.URI({scheme:"https",authority:"outlook.live.com",path:"/mail/deeplink/compose",query:{subject:e.subject,body:e.body,popoutv2:"1"}})},k=function(e){return new i.URI({scheme:"https",authority:"wa.me",path:"/",query:{text:e.body}})};t.ExtensionsPopoverContentWithUnity=function(e){return n.default.createElement(h.WithUnity,{file:e.file,user:e.user,render:function(t){return n.default.createElement(T,a.__assign({},e,{unityInfo:t}))}})},t.ExtensionsPopoverContentNoUnity=s.requireCssWithComponent(T,["/static/css/app_actions/index-vflcVf0Of.css"])});
//# sourceMappingURL=extensions_popover_content_component.min.js-vflFpydiv.map